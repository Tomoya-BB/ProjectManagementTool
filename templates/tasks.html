{% extends "base.html" %}
{% block content %}
<h2>ğŸ“‹ ã‚¿ã‚¹ã‚¯ä¸€è¦§</h2>

<!-- ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
{% if current_user.role != 'Viewer' %}
<div class="mb-4 p-3 border rounded bg-light">
  <h5>æ–°è¦ã‚¿ã‚¹ã‚¯è¿½åŠ </h5>
  <form method="POST" class="row g-3">
    <div class="col-md-6">
      <label class="form-label">ã‚¿ã‚¹ã‚¯å</label>
      <input type="text" name="name" class="form-control" required>
    </div>
    <div class="col-md-3">
      <label class="form-label">é–‹å§‹æ—¥</label>
      <input type="date" name="start_date" class="form-control" required>
    </div>
    <div class="col-md-3">
      <label class="form-label">çµ‚äº†æ—¥</label>
      <input type="date" name="end_date" class="form-control" required>
    </div>
    <div class="col-12">
      <label class="form-label">å‚™è€ƒ</label>
      <textarea name="remarks" class="form-control" rows="2"></textarea>
    </div>
    <div class="col-md-4">
      <label class="form-label">æ‹…å½“è€…</label>
      <select name="assignee_id" class="form-select">
        <option value="">-- æœªè¨­å®š --</option>
        {% for m in members %}
          <option value="{{ m.id }}">{{ m.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">å…ˆè¡Œã‚¿ã‚¹ã‚¯ (ä¾å­˜é–¢ä¿‚)</label>
      <select name="predecessors" multiple class="form-select">
        {% for t in tasks %}
          <option value="{{ t.id }}">{{ t.name }}</option>
        {% endfor %}
      </select>
      <small class="text-muted">â€»ã“ã®æ–°ã‚¿ã‚¹ã‚¯ãŒé–‹å§‹ã™ã‚‹å‰ã«å®Œäº†ã™ã¹ãã‚¿ã‚¹ã‚¯ã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</small>
    </div>
    <div class="col-md-4">
      <label class="form-label">è¦ªã‚¿ã‚¹ã‚¯ (ãƒ•ã‚§ãƒ¼ã‚º)</label>
      <select name="parent_id" class="form-select">
        <option value="">-- ãªã— --</option>
        {% for t in tasks if not t.parent_id %}
          <option value="{{ t.id }}">{{ t.name }}</option>
        {% endfor %}
      </select>
      <small class="text-muted">â€»ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å«ã‚€ãƒ•ã‚§ãƒ¼ã‚ºã‚„è¦ªã‚¿ã‚¹ã‚¯ãŒã‚ã‚Œã°é¸æŠ</small>
    </div>
    <div class="col-md-4">
      <label class="form-label">é€²æ—ç‡</label>
      <div class="input-group">
        <input type="number" name="progress" class="form-control" value="0" min="0" max="100">
        <span class="input-group-text">%</span>
      </div>
    </div>
    <div class="col-12">
      <button type="submit" class="btn btn-primary">è¿½åŠ </button>
    </div>
  </form>
</div>
{% endif %}

<!-- ã‚¿ã‚¹ã‚¯ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
<table class="table table-sm table-hover align-middle">
  <thead class="table-light">
    <tr>
      <th>No</th><th>ã‚¿ã‚¹ã‚¯å</th><th>é–‹å§‹æ—¥</th><th>çµ‚äº†æ—¥</th>
      <th>æ‹…å½“è€…</th><th>é€²æ—</th><th>å…ˆè¡Œã‚¿ã‚¹ã‚¯</th><th>å‚™è€ƒ</th><th>æ“ä½œ</th>
    </tr>
  </thead>
  <tbody>
    {% for t in tasks %}
    <tr class="{% if t.progress == 100 %}table-success{% elif t.end_date < current_date and t.progress < 100 %}table-danger{% endif %}">
      <td>{{ loop.index }}</td>
      <td>
        {% if t.parent_id %} &emsp; ğŸ”¹ {% endif %}
        {{ t.name }}
      </td>
      <td>{{ t.start_date }}</td>
      <td>{{ t.end_date }}</td>
      <td>{{ t.assignee.name if t.assignee else '' }}</td>
      <td>{{ t.progress }}%</td>
      <td>
        {% set preds = [] %}
        {% for dep in deps if dep.successor_id == t.id %}
          {% set _ = preds.append(dep.predecessor.name) %}
        {% endfor %}
        {{ preds|join(', ') }}
      </td>
      <td>{{ t.remarks }}</td>
      <td>
        {% if current_user.role != 'Viewer' %}
          <a href="{{ url_for('edit_task', task_id=t.id) }}" class="btn btn-sm btn-secondary">ç·¨é›†</a>
          <form action="{{ url_for('delete_task', task_id=t.id) }}" method="POST" class="d-inline">
            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('å‰Šé™¤ã—ã¾ã™ã‹?');">å‰Šé™¤</button>
          </form>
        {% else %}
          <small class="text-muted">é–²è¦§ã®ã¿</small>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º -->
<h3 class="mt-5">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</h3>
<div class="gantt-chart-container" style="overflow-x: auto; position: relative; padding: 1rem; border: 1px solid #ccc;">
  <!-- æ¨ªè»¸ï¼ˆæœŸé–“ï¼‰ -->
  {% set project_start = tasks|map(attribute='start_date')|min %}
  {% set project_end = tasks|map(attribute='end_date')|max %}
  {% for d in range((project_end - project_start).days + 1) %}
    {% set day_label = project_start + d*day %}
    <div class="gantt-day-label" style="display:inline-block; width:20px;">
      {{ day_label.day }}{% if day_label.day == 1 %}æœˆ{% endif %}
    </div>
  {% endfor %}
  <div class="position-relative" style="margin-top: 1.5rem;">
    {% for t in tasks %}
      {% set offset = (t.start_date - project_start).days * 20 %}
      {% set duration = (t.end_date - t.start_date).days * 20 + 20 %}
      {% set status_class = 'bar-complete' if t.progress == 100 else 'bar-delayed' if (t.end_date < current_date and t.progress < 100) else 'bar-ongoing' %}
      <div class="gantt-bar {{ status_class }}" 
           style="position: absolute; left: {{ offset }}px; width: {{ duration }}px;"
           title="{{ t.name }}: {{ t.progress }}%å®Œäº†ï¼ˆ{{ t.start_date }} - {{ t.end_date }}{% if t.assignee %}, æ‹…å½“: {{ t.assignee.name }}{% endif %}ï¼‰">
        {{ t.name }}
      </div>
      {% for dep in deps if dep.predecessor_id == t.id %}
        {% set succ_task = tasks|selectattr('id', 'equalto', dep.successor_id)|first %}
        {% if succ_task %}
          <div class="gantt-dependency-line" 
               style="position: absolute; left: {{ (t.end_date - project_start).days * 20 + 20 }}px; top: {{ loop.index0 * 1.5 }}rem; width: {{ ((succ_task.start_date - t.end_date).days) * 20 - 4 }}px; border-bottom: 2px solid #000;">
          </div>
          <div class="gantt-dependency-arrow" 
               style="position: absolute; left: {{ (succ_task.start_date - project_start).days * 20 }}px; top: {{ loop.index0 * 1.5 }}rem; width: 0; height: 0; border-top: 5px solid transparent; border-bottom: 5px solid transparent; border-left: 5px solid #000;">
          </div>
        {% endif %}
      {% endfor %}
    {% endfor %}
  </div>
</div>
{% endblock %}
